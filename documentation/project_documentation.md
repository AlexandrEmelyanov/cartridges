# Документация к проекту

## Модели ([models.py](..%2Fapp%2Fmodels.py))

В проекте используется база данных: SQLite3. Для визуализации таблиц и данных можете воспользоваться инструментом: 
[DB Browser for SQLite](https://sqlitebrowser.org/).

### Модель "Orders"

Описание модели и её полей:

| Поле      | Тип               | Описание                                                                                                                                                   |
| --------- |-------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------|
| department| CharField         | Отдел, который сделал заказ (заполняется вручную)                                                                                                          |
| status    | SmallIntegerField | Статус заказа ("В работе" - по умолчанию при создании, "Готов к выдаче", "Выдан").<br/> В представлении (функции) обрабатывается в числовом виде (1, 2, 3) |
| created   | DateTimeField     | Дата создания заказа (создается автоматически)                                                                                                             |


### Модель "Users"

Описание модели:

Поскольку авторизация используется только для администратора, то в проекте используется встроенная модель пользователей
в Django. В ней по умолчанию имеются все необходимые поля для регистрации, поэтому определение этой модели в 
**models.py** не требуется.

Поскольку в проекте не реализована возможность регистрации для пользователей. Для создания аккаунта для администратора
необходимо перейти в корневую папку проекта (на уровень с файлом **manage.py**). В терминале:

```python
python manage.py createsuperuser
```

Ввести логин, пароль и почту. Далее можно авторизоваться на самом сайте.


## Формы ([forms.py](..%2Fapp%2Fforms.py))

### Форма "SuperUserLoginForm"

Описание формы и её полей:

| Поле      | Тип        | Описание                                                                                                    |
| --------- |------------|-------------------------------------------------------------------------------------------------------------|
| username  | CharField  | В качестве атрибутов передаются: "class" и "placeholder", чтобы к полям  формы применились нужные стили CSS |
| password  | CharField  | Помимо атрибутов: "class" и "placeholder", так же передается атрибут "type", чтобы ввод пароля был скрыт    |

Используется исключительно для авторизации администратора. Также внутри формы определен **class Meta**, в котором 
указаны: с какой моделью и какими полями модели работает форма.

### Форма "OrderCreateForm"

Используется для создания нового заказа. На сайте доступна только авторизованному пользователю (администратору). 
Определено только одно поле "department", потому что остальные поля в таблице создаются автоматически ("status" - по 
умолчанию "В работе".

## Представления ([views.py](..%2Fapp%2Fviews.py))

### Представление "main"

Описание представления "main" и его функционала:

```python
    def main(request):
        if request.method == 'POST':
            info = request.POST.get('status')
            if info:
                data = info.split(' ')
                status = int(data[0])
                order = Orders.objects.get(id=int(data[1]))
                if order and status:
                    order.status = status
                    order.save()
                    messages.success(request, 'Данные успешно изменены!')
                    return HttpResponseRedirect(reverse('index:cartridges'))
            else:
                messages.error(request, 'Данный статус уже применен!')
    
        orders = Orders.objects.filter(status__lte=2)
        context = {
            'title': 'Статус заказов',
            'orders': orders,
        }
    
        return render(request=request, template_name='app/index.html', context=context)
```
Представление для работы с главной страницей сайта и ее отображения. Вывод списка заказов и статусов, возможность редактирование 
статусов и переходов к страницам авторизации и добавления новых заказов (для авторизованного пользователя -
администратора).

В представлении выполнена проверка на тип запроса, который пришел **POST** или **GET**: 

- Если **GET** - отобразится список заказов и их статусов (из модели **Orders**), для этого в переменной 
**orders** обращаемся к менеджеру **objects**, позволяющему делать запросы к БД 
([Django ORM](https://docs.djangoproject.com/en/5.0/topics/db/queries/)) и получаем список по фильтру, статус которых 
меньше либо равен 2 (т.е "В работе" или "Готов к выдаче"). Таким образом заказы, которые в статусе "Выдан" (3), не будут 
отображены на странице, но будут сохранены в БД. Список передается в переменную **context**, в качестве значения словаря (ключ
может иметь любое название). В шаблоне можно обратиться к этому атрибуту с помощью конструкции {{ name_key }} или 
использовать в цикле или условии.


- Если **POST** - (при смене статуса заказа администратором). Данные берутся из **POST-запроса** по имени: 
"status", который определен в шаблоне для тега **select**. В нем храниться список из **id** заказа и нового 
выставленного **статуса** (в числовом виде). Если данные пустые (или применен тот же статус, что и был), то всплывет 
окно с предупреждением (message.error). Если статус "новый", то берется числовое значение, определенное в теге 
**option** для конкретного статуса. В переменной **order** храниться заказ, полученный по **id** из списка "status". 
Если такой заказ есть в БД и пришел корректный статус, то у этого заказа меняется статус на новый и сохраняется в БД. 
Выводиться сообщение об успешном изменении данных и пользователя (администратора) перенаправит на эту же (главную) 
страницу.


- Представление возвращает с помощью функции **render** шаблон, который отобразиться пользователю. Обязательные 
аргументы: **request** и **template_name** (шаблон, который будет отображен).

Также в context передается **title**, который используется в блоке: {% block title %} шаблона 
[index.html](..%2Fapp%2Ftemplates%2Fapp%2Findex.html) для отображения заголовка, с помощью обращения к атрибуту 
{{ title }}.


### Представление "login"

Описание представления "login" и его функционала:

```python
    def login(request):
        if request.method == 'POST':
            form = SuperUserLoginForm(data=request.POST)
            if form.is_valid():
                username = request.POST['username']
                password = request.POST['password']
                user = auth.authenticate(username=username, password=password)
                if user:
                    auth.login(request=request, user=user)
                    return HttpResponseRedirect(reverse('index:cartridges'))
    
        else:
            form = SuperUserLoginForm()
    
        context = {
            'form': form,
            'title': 'Авторизация'
        }
        return render(request=request, template_name='app/login.html', context=context)
```

Представление для работы с авторизацией и отображения страницы (шаблона) авторизации.

В представлении выполнена проверка на тип запроса, который пришел: **POST** или **GET**: 

- Если **GET** - на странице будет отображена форма **SuperUserLoginForm()** с пустыми полями для авторизации.


- Если **POST** - в переменной **form** заполняется форма данными, которые пришли. Выполняется проверка на
валидность формы. Если форма не валидна (неверные или не корректно введенные данные: логин и пароль), то пользователь
увидит сообщение об ошибке (ошибка не передается явно, это делает django "под капотом"). Если форма валидна, то
выполняется аутентификация пользователя ```user = auth.authenticate(username=username, password=password)```, по 
**username** и **password**. Если такой пользователь есть, то выполняется его авторизация
```auth.login(request=request, user=user)```. Далее пользователя перенаправляет на главную страницу сайта.


### Представление "create_order"

Описание представления "create_order" и его функционала:

```python
    def create_order(request):
        if request.method == 'POST':
            form_create = OrderCreateForm(data=request.POST)
            if form_create.is_valid():
                new_order = Orders.objects.create(department=request.POST['department'])
                new_order.save()
                messages.success(request, 'Заказ успешно добавлен!')
                return HttpResponseRedirect(reverse('index:cartridges'))
    
        else:
            form_create = OrderCreateForm()
    
        context = {
            'form_create': form_create,
            'title': 'Создание заказа'
        }
        return render(request=request, template_name='app/create-order.html', context=context)
```

Представление для работы с созданием нового заказа и отображения страницы (шаблона) для создания. Возможность добавления
нового заказа доступна только авторизованному пользователю (администратору).

В представлении выполнена проверка на тип запроса, который пришел: **POST** или **GET**: 

- Если **GET** - на странице будет отображена форма **OrderCreateForm()** с пустым полем ввода "Отдел".

- Если **POST** - форма будет заполнена полученными данными ```form_create = OrderCreateForm(data=request.POST)```.
После проверки на валидность, будет создан новый заказ - new_order (с помощью Django ORM) и сохранен в базе данных.
Пользователя (администратора) перенаправит на главную страницу с сообщением об успешном добавлении заказа.


## Шаблоны HTML ([templates/app](..%2Fapp%2Ftemplates%2Fapp))

1) Базовый шаблон ([base.html](..%2Fapp%2Ftemplates%2Fapp%2Fbase.html)) - от него наследуются
шаблоны: [index.html](..%2Fapp%2Ftemplates%2Fapp%2Findex.html) и 
[create-order.html](..%2Fapp%2Ftemplates%2Fapp%2Fcreate-order.html), c помощью тега: 
{% extends 'name_app/name_template.html' %}. Подробнее о тегах можно посмотреть в [официальной документации
Django](https://docs.djangoproject.com/en/5.0/ref/templates/builtins/). В базовом шаблоне определены общие части всех 
представлений (такие, как стили и скрипты), а те блоки, которые отличаются: {% block title %} и {% block content %} 
берутся из дочерних шаблонов.


2) [index.html](..%2Fapp%2Ftemplates%2Fapp%2Findex.html) - основной шаблон (главная страница), в котором реализован 
вывод заказов и их статусов. Если пользователь авторизован (администратор), то появляется возможность изменения статуса 
заказа и добавление новых заказов.


3) [create-order.html](..%2Fapp%2Ftemplates%2Fapp%2Fcreate-order.html) - шаблон создания нового заказа.


4) [login.html](..%2Fapp%2Ftemplates%2Fapp%2Flogin.html) - шаблон авторизации.


## Маршрутизаторы ([cartridges/urls.py](..%2Fcartridges%2Furls.py) и [app/urls.py](..%2Fapp%2Furls.py))

1) В главном маршрутизаторе ([cartridges/urls.py](..%2Fcartridges%2Furls.py)) определены основные маршруты URL-адресов 
для всего проекта:

```python
urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('app.urls', namespace='index')),
]
```

- В нем подключен маршрут для перехода к админ-панели и включение маршрутизатора [app/urls.py](..%2Fapp%2Furls.py) для 
главной (домашней) страницы по ```namespace='index'```.

2) Маршрутизатор приложения [app/urls.py](..%2Fapp%2Furls.py):

```python
app_name = 'index'

urlpatterns = [
    path('', views.main, name='cartridges'),
    path('create/', views.create_order, name='create-order'),
    path('login/', views.login, name='login'),
    path('logout/', auth_views.LogoutView.as_view(), name='logout'),
]
```

- ```app_name = 'index'``` - namespace из маршрутизатора проекта.


- Далее в списке **urlpatterns** указаны URL-адреса, которые определяют, какие представления будут вызываться при 
обращении к определенным URL-адресам.


- ```path('', views.main, name='cartridges')``` - определяет маршрут для домашней страницы, связан с представлением 
**main**. Для обращения к данному маршруту в шаблонах и представлениях или генерации URL-адресов задано имя 
**'cartridges'**. Пустая строка обозначает, что по маршруту http://127.0.0.1:8000/ будет отрабатывать
указанное представление.


- ```path('create/', views.create_order, name='create-order')``` - маршрут для создания нового заказа, связан с 
представлением **create_order**: http://127.0.0.1:8000/create/ 


- ```path('login/', views.login, name='login')``` - маршрут для авторизации, связан с представлением **login**:
http://127.0.0.1:8000/login/ 


- ```path('logout/', auth_views.LogoutView.as_view(), name='logout')``` - маршрут для выхода из аккаунта, связан с
встроенным в django классом. Для указания представления в виде класса используется вызов метода: **as_view()**.


## Админ-панель ([admin.py](..%2Fapp%2Fadmin.py))

Определен класс "OrdersAdmin", который регистрирует модель "Orders" в админ-панели. Также определены отображаемые поля в 
таблице, поля при создании заказа и не редактируемые поля.

Админ-панель доступна по адресу: http://127.0.0.1:8000/admin 

Здесь вы можете удалять, редактировать и добавлять записи (заказы) в таблице "Orders" (БД).